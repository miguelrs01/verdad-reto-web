<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pack Creator Admin ‚Äî Web</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(6px); }
    .scrollbar-thin::-webkit-scrollbar { height: 8px; width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { border-radius: 999px; background: rgba(0,0,0,0.2);} 
  </style>
</head>
<body class="bg-gradient-to-br from-sky-50 to-white min-h-screen text-slate-800">

  <div class="max-w-7xl mx-auto p-6">

    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl font-extrabold">Pack Creator Admin</h1>
      <div class="text-sm text-slate-600">Desplegable en GitHub Pages ¬∑ Firestore (client-side)</div>
    </header>

    <div id="loginSection" class="p-6 max-w-md mx-auto">
      <h2 class="text-xl font-bold mb-2">Acceso restringido</h2>
      <button id="loginBtn" class="bg-sky-600 text-white px-3 py-2 rounded">Entrar con Google</button>
      <div id="loginError" class="text-red-500 text-sm mt-2"></div>
    </div>

    <main class="hidden grid grid-cols-12 gap-6">
      <!-- Sidebar: Packs -->
      <aside class="col-span-3">
        <div class="p-4 rounded-2xl shadow-md glass">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Packs</h2>
            <button id="btnRefresh" class="px-3 py-1 text-sm rounded bg-sky-600 text-white hover:bg-sky-700">Refrescar</button>
          </div>
          <div id="packsList" class="space-y-2 max-h-[60vh] overflow-auto scrollbar-thin"></div>
          <hr class="my-3" />
          <button id="btnNewPack" class="w-full py-2 rounded-lg border border-dashed border-slate-200 hover:bg-slate-50">+ Nuevo Pack</button>
        </div>
      </aside>

      <!-- Editor + Items -->
      <section class="col-span-9">
        <div class="p-6 rounded-2xl shadow-md glass">
          <form id="packForm" class="grid grid-cols-3 gap-4 items-end">
            <div class="col-span-2">
              <label class="block text-sm font-medium">Nombre</label>
              <input id="name" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="Nombre del pack" />
            </div>
            <div>
              <label class="block text-sm font-medium">Activo</label>
              <div class="mt-1"><input id="isActive" type="checkbox" class="h-5 w-5" checked /></div>
            </div>

            <div class="col-span-3">
              <label class="block text-sm font-medium">Descripci√≥n</label>
              <input id="description" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="Descripci√≥n corta" />
            </div>

            <div>
              <label class="block text-sm font-medium">Precio</label>
              <input id="price" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="e.g. 1.99" />
            </div>

            <div>
              <label class="block text-sm font-medium">Icono</label>
              <input id="icon" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="emoji o nombre" />
            </div>

            <div class="flex gap-2 col-span-3">
              <button id="btnSavePack" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Guardar pack</button>
              <button id="btnDeletePack" type="button" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Eliminar pack</button>
              <div id="packIdDisplay" class="ml-auto text-sm text-slate-500 self-center"></div>
            </div>
          </form>

          <div class="mt-6 grid grid-cols-2 gap-4">
            <div>
              <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold">Preguntas</h3>
                <button id="btnAddQuestion" class="text-sm px-3 py-1 rounded bg-indigo-600 text-white">A√±adir</button>
              </div>
              <div id="questionsList" class="max-h-[40vh] overflow-auto scrollbar-thin space-y-2"></div>
            </div>

            <div>
              <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold">Retos</h3>
                <button id="btnAddDare" class="text-sm px-3 py-1 rounded bg-rose-600 text-white">A√±adir</button>
              </div>
              <div id="daresList" class="max-h-[40vh] overflow-auto scrollbar-thin space-y-2"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-sm text-slate-500">Recuerda configurar Firestore (security rules) y la <code>firebaseConfig</code> antes de publicar.</footer>
  </div>

  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-2xl p-6 w-full max-w-xl shadow-lg">
      <h4 id="modalTitle" class="font-semibold mb-2">Editor</h4>
      <div class="space-y-3">
        <input id="itemText" placeholder="Texto" class="w-full rounded border px-3 py-2" />
        <input id="itemCategory" placeholder="Categor√≠a" class="w-full rounded border px-3 py-2" />
        <select id="itemType" class="w-full rounded border px-3 py-2">
          <option value="question">Pregunta</option>
          <option value="dare">Reto</option>
        </select>
      </div>
      <div class="mt-4 flex justify-end gap-3">
        <button id="modalCancel" class="px-4 py-2 rounded border">Cancelar</button>
        <button id="modalSave" class="px-4 py-2 rounded bg-sky-600 text-white">Guardar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDZJqOx5eXpu3cD_FBJ8oi-hYvLCpbDXE",
      authDomain: "verdadreto-bec6a.firebaseapp.com",
      projectId: "verdadreto-bec6a",
      storageBucket: "verdadreto-bec6a.firebasestorage.app",
      messagingSenderId: "938969209658",
      appId: "1:938969209658:web:534282f57a8ff381c00e03"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const packsList = document.getElementById('packsList');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnNewPack = document.getElementById('btnNewPack');
    const btnSavePack = document.getElementById('btnSavePack');
    const btnDeletePack = document.getElementById('btnDeletePack');
    const packIdDisplay = document.getElementById('packIdDisplay');
    const nameInput = document.getElementById('name');
    const descInput = document.getElementById('description');
    const priceInput = document.getElementById('price');
    const iconInput = document.getElementById('icon');
    const isActiveInput = document.getElementById('isActive');
    const questionsList = document.getElementById('questionsList');
    const daresList = document.getElementById('daresList');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalCancel = document.getElementById('modalCancel');
    const modalSave = document.getElementById('modalSave');
    const itemText = document.getElementById('itemText');
    const itemCategory = document.getElementById('itemCategory');
    const itemType = document.getElementById('itemType');

    let selectedPackId = null;
    let editingItemId = null;

    // ------------------- AUTENTICACI√ìN -------------------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.getElementById("loginSection").classList.remove("hidden");
        document.querySelector("main").classList.add("hidden");
      } else {
        await checkUserAuthorization(user);
      }
    });

    document.getElementById("loginBtn").addEventListener("click", async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        await checkUserAuthorization(user);
      } catch (err) {
        document.getElementById("loginError").innerText = err.message;
      }
    });

    async function checkUserAuthorization(user) {
      const settingsRef = doc(db, "portalConfig", "settings");
      const snap = await getDoc(settingsRef);
      if (!snap.exists()) {
        document.body.innerHTML = "<p class='p-6 text-red-600'>‚ö†Ô∏è Configuraci√≥n no encontrada</p>";
        return;
      }

      const allowed = snap.data().allowedEmails || [];
      if (!allowed.includes(user.email)) {
        document.body.innerHTML = "<p class='p-6 text-red-600'>üö´ Usuario no autorizado</p>";
        return;
      }

      // Usuario autorizado
      document.getElementById("loginSection").classList.add("hidden");
      document.querySelector("main").classList.remove("hidden");
      fetchPacks();
    }

    // ------------------- CRUD PACKS -------------------
    async function fetchPacks() {
      packsList.innerHTML = 'Cargando...';
      const snap = await getDocs(collection(db, 'packs'));
      packsList.innerHTML = '';
      snap.forEach(d => {
        const pack = d.data(), id = d.id;
        const node = document.createElement('div');
        node.className = 'p-3 rounded-lg hover:bg-slate-50 flex justify-between items-center cursor-pointer';
        node.innerHTML = `<div><div class="font-medium">${escapeHtml(pack.name||id)}</div><div class="text-xs text-slate-500">${escapeHtml(pack.description||'')}</div></div><div class="text-sm">${pack.isActive? '‚úÖ': '‚ùå'}</div>`;
        node.addEventListener('click', ()=> selectPack(id));
        packsList.appendChild(node);
      });
    }

    async function selectPack(id) {
      selectedPackId = id;
      packIdDisplay.textContent = id;
      const d = await getDoc(doc(db, 'packs', id));
      if(!d.exists()) return;
      const p = d.data();
      nameInput.value = p.name || '';
      descInput.value = p.description || '';
      priceInput.value = p.price || '';
      iconInput.value = p.icon || '';
      isActiveInput.checked = !!p.isActive;
      await fetchItems(id);
    }

    async function savePack(e) {
      e.preventDefault();
      const name = nameInput.value.trim();
      if(!name) { alert('Escribe un nombre'); return; }
      const id = name.toLowerCase().replace(/\s+/g,'_');
      const payload = { id, name, description: descInput.value, price: priceInput.value, icon: iconInput.value, isActive: isActiveInput.checked };
      await setDoc(doc(db, 'packs', id), payload, { merge: true });
      await fetchPacks();
      selectPack(id);
      alert('Pack guardado');
    }

    async function deletePack() {
      if(!selectedPackId) return alert('Selecciona un pack');
      if(!confirm('¬øEliminar pack y sus items?')) return;
      const itemsQ = query(collection(db, 'gameItems'), where('packId','==',selectedPackId));
      const itemsSnap = await getDocs(itemsQ);
      for(const it of itemsSnap.docs) await deleteDoc(doc(db, 'gameItems', it.id));
      await deleteDoc(doc(db, 'packs', selectedPackId));
      selectedPackId = null;
      packIdDisplay.textContent = '';
      clearForm();
      await fetchPacks();
      alert('Eliminado');
    }

    function clearForm() {
      nameInput.value='';
      descInput.value='';
      priceInput.value='';
      iconInput.value='';
      isActiveInput.checked = true;
      questionsList.innerHTML='';
      daresList.innerHTML='';
    }

    // ------------------- CRUD ITEMS -------------------
    async function fetchItems(packId) {
	  questionsList.innerHTML = 'Cargando...';
	  daresList.innerHTML = 'Cargando...';

	  const qSnap = await getDocs(query(collection(db, 'gameItems'), where('packId', '==', packId)));
	  
	  // Limpiar listas
	  questionsList.innerHTML = '';
	  daresList.innerHTML = '';

	  qSnap.forEach(d => {
		const it = d.data();
		const id = d.id;

		const node = document.createElement('div');
		node.className = 'p-2 rounded-md border flex justify-between items-start gap-2';
		node.innerHTML = `<div>
							<div class="font-medium">${escapeHtml(it.text)}</div>
							<div class="text-xs text-slate-500">${escapeHtml(it.category)}</div>
						  </div>
						  <div class="flex gap-2">
							<button data-id="${id}" class="editBtn text-sm px-2 py-1 rounded bg-yellow-400">Editar</button>
							<button data-id="${id}" class="delBtn text-sm px-2 py-1 rounded bg-red-500 text-white">Eliminar</button>
						  </div>`;

		if(it.type === 'question') questionsList.appendChild(node);
		else if(it.type === 'dare') daresList.appendChild(node);
	  });

	  // Attach handlers
	  document.querySelectorAll('.editBtn').forEach(b => b.addEventListener('click', ()=> openEditItem(b.dataset.id)));
	  document.querySelectorAll('.delBtn').forEach(b => b.addEventListener('click', async ()=>{
		if(confirm('Eliminar item?')){
		  await deleteDoc(doc(db, 'gameItems', b.dataset.id));
		  fetchItems(packId);
		}
	  }));
	}

    function openModal(){ modal.classList.remove('hidden'); modal.style.display='flex'; }
    function closeModal(){ modal.classList.add('hidden'); modal.style.display='none'; }
    function openNewItem(type){ editingItemId=null; itemType.value=type; itemText.value=''; itemCategory.value=''; modalTitle.textContent = type==='question'?'Nueva Pregunta':'Nuevo Reto'; openModal(); }
    async function openEditItem(itemId){ const d=await getDoc(doc(db,'gameItems',itemId)); if(!d.exists()) return; const it=d.data(); editingItemId=itemId; itemText.value=it.text||''; itemCategory.value=it.category||''; itemType.value=it.type||'question'; modalTitle.textContent='Editar item'; openModal(); }

    modalCancel.addEventListener('click', closeModal);
    modalSave.addEventListener('click', async ()=>{
      const text=itemText.value.trim(), category=itemCategory.value.trim(), type=itemType.value;
      if(!text||!category) return alert('Completa todos los campos');
      if(!selectedPackId) return alert('Selecciona un pack primero');
      if(editingItemId){
        await updateDoc(doc(db,'gameItems',editingItemId),{text,category,type});
      } else {
        await addDoc(collection(db,'gameItems'),{packId:selectedPackId,type,text,category});
      }
      closeModal();
      fetchItems(selectedPackId);
    });

    btnRefresh.addEventListener('click', fetchPacks);
    btnNewPack.addEventListener('click', ()=>{ clearForm(); selectedPackId=null; packIdDisplay.textContent='(nuevo)'; });
    btnSavePack.addEventListener('click', savePack);
    btnDeletePack.addEventListener('click', deletePack);
    document.getElementById('btnAddQuestion').addEventListener('click', ()=>openNewItem('question'));
    document.getElementById('btnAddDare').addEventListener('click', ()=>openNewItem('dare'));

    function escapeHtml(text){ if(!text) return ''; return String(text).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
  </script>

</body>
</html>

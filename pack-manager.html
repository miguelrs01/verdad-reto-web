<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pack Creator Admin — Web</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(6px); }
    .scrollbar-thin::-webkit-scrollbar { height: 8px; width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { border-radius: 999px; background: rgba(0,0,0,0.2);} 
  </style>
</head>
<body class="bg-gradient-to-br from-sky-50 to-white min-h-screen text-slate-800">

  <div class="max-w-7xl mx-auto p-6">

    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl font-extrabold">Pack Creator Admin</h1>
      <div class="text-sm text-slate-600">Desplegable en GitHub Pages · Firestore (client-side)</div>
    </header>

    <div id="loginSection" class="p-6 max-w-md mx-auto">
      <h2 class="text-xl font-bold mb-2">Acceso restringido</h2>
      <button id="loginBtn" class="bg-sky-600 text-white px-3 py-2 rounded">Entrar con Google</button>
      <div id="loginError" class="text-red-500 text-sm mt-2"></div>
    </div>

    <main class="hidden grid grid-cols-12 gap-6">
      <!-- Sidebar: Navigation -->
      <aside class="col-span-3">
        <!-- Navigation Tabs -->
        <div class="mb-6 flex flex-wrap gap-2">
          <button id="tabPacks" class="px-4 py-2 rounded-lg font-medium bg-sky-600 text-white shadow-md hover:bg-sky-700 transition-colors">Packs</button>
          <button id="tabSuggestions" class="px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">Sugerencias</button>
          <button id="tabIncidents" class="px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">Incidencias</button>
          <button id="tabStats" class="px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">Estadísticas</button>
          <button id="tabAds" class="px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">Anuncios</button>
          <button id="tabWelcome" class="px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">Ventana Inicial</button>
        </div>
        
        <!-- Packs Section -->
        <div id="packsSection" class="p-4 rounded-2xl shadow-md glass">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Packs</h2>
            <button id="btnRefresh" class="px-3 py-1 text-sm rounded bg-sky-600 text-white hover:bg-sky-700">Refrescar</button>
          </div>
          <div id="packsList" class="space-y-2 max-h-[60vh] overflow-auto scrollbar-thin"></div>
          <hr class="my-3" />
          <button id="btnNewPack" class="w-full py-2 rounded-lg border border-dashed border-slate-200 hover:bg-slate-50">+ Nuevo Pack</button>
        </div>
        
        <!-- Suggestions Section -->
        <div id="suggestionsSection" class="p-4 rounded-2xl shadow-md glass hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Sugerencias</h2>
            <button id="btnRefreshSuggestions" class="px-3 py-1 text-sm rounded bg-sky-600 text-white hover:bg-sky-700">Refrescar</button>
          </div>
          <div class="mb-3">
            <select id="suggestionStatusFilter" class="w-full px-3 py-2 text-sm border rounded-md">
              <option value="all">Todas las sugerencias</option>
              <option value="pending">Pendientes</option>
              <option value="possible">Posibles</option>
              <option value="accepted">Aceptadas</option>
              <option value="rejected">Descartadas</option>
            </select>
          </div>
          <div id="suggestionsList" class="space-y-2 max-h-[60vh] overflow-auto scrollbar-thin"></div>
        </div>
        
        <!-- Incidents Section -->
        <div id="incidentsSection" class="p-4 rounded-2xl shadow-md glass hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Incidencias</h2>
            <button id="btnRefreshIncidents" class="px-3 py-1 text-sm rounded bg-sky-600 text-white hover:bg-sky-700">Refrescar</button>
          </div>
          <div class="mb-3">
            <select id="incidentStatusFilter" class="w-full px-3 py-2 text-sm border rounded-md">
              <option value="all">Todas las incidencias</option>
              <option value="pending">Pendientes</option>
              <option value="in_review">En revisión</option>
              <option value="resolved">Resueltas</option>
            </select>
          </div>
          <div id="incidentsList" class="space-y-2 max-h-[60vh] overflow-auto scrollbar-thin"></div>
        </div>
        
        <!-- Statistics Section -->
        <div id="statsSection" class="p-4 rounded-2xl shadow-md glass hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Estadísticas</h2>
            <div class="flex gap-2">
              <select id="statsTimeFilter" class="px-3 py-1 text-sm rounded border">
                <option value="realtime">Tiempo Real</option>
                <option value="day">Hoy</option>
                <option value="month">Este Mes</option>
                <option value="year">Este Año</option>
              </select>
              <button id="btnRefreshStats" class="px-3 py-1 text-sm rounded bg-sky-600 text-white hover:bg-sky-700">Refrescar</button>
            </div>
          </div>
          
          <!-- Statistics Cards -->
          <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-blue-50 p-3 rounded-lg">
              <div class="text-sm text-blue-600 font-medium">Usuarios Totales</div>
              <div id="totalUsers" class="text-2xl font-bold text-blue-800">-</div>
            </div>
            <div class="bg-green-50 p-3 rounded-lg">
              <div class="text-sm text-green-600 font-medium">Usuarios Activos</div>
              <div id="activeUsers" class="text-2xl font-bold text-green-800">-</div>
            </div>
            <div class="bg-purple-50 p-3 rounded-lg">
              <div class="text-sm text-purple-600 font-medium">Partidas Jugadas</div>
              <div id="totalGames" class="text-2xl font-bold text-purple-800">-</div>
            </div>
            <div class="bg-yellow-50 p-3 rounded-lg">
              <div class="text-sm text-yellow-600 font-medium">Demos Usados</div>
              <div id="totalDemos" class="text-2xl font-bold text-yellow-800">-</div>
            </div>
          </div>
          
          <!-- User Type Breakdown -->
          <div class="mb-4">
            <h3 class="text-sm font-medium mb-2">Tipos de Usuario</h3>
            <div class="grid grid-cols-2 gap-2">
              <div class="bg-gray-50 p-2 rounded text-center">
                <div class="text-sm text-gray-600">Registrados</div>
                <div id="registeredUsers" class="font-bold text-gray-800">-</div>
              </div>
              <div class="bg-gray-50 p-2 rounded text-center">
                <div class="text-sm text-gray-600">Anónimos</div>
                <div id="anonymousUsers" class="font-bold text-gray-800">-</div>
              </div>
            </div>
          </div>
          
          <!-- Most Played Packs -->
          <div>
            <h3 class="text-sm font-medium mb-2">Packs Más Jugados</h3>
            <div id="mostPlayedPacks" class="space-y-1 max-h-32 overflow-auto">
              <div class="text-center text-gray-500 py-2">Cargando...</div>
            </div>
          </div>
        </div>
        
        <!-- Ads Section -->
        <div id="adsSection" class="p-4 rounded-2xl shadow-md glass hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Configuración de Anuncios</h2>
            <button id="btnRefreshAds" class="px-3 py-1 text-sm rounded bg-sky-600 text-white hover:bg-sky-700">Refrescar</button>
          </div>
          
          <!-- Ad Configuration Status -->
          <div class="mb-4">
            <div class="bg-blue-50 p-3 rounded-lg">
              <div class="text-sm text-blue-600 font-medium">Estado del Sistema</div>
              <div id="adsSystemStatus" class="text-lg font-bold text-blue-800">Cargando...</div>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="space-y-2">
            <button id="btnEnableAllAds" class="w-full py-2 px-3 text-sm rounded bg-green-600 text-white hover:bg-green-700">Activar Todos los Anuncios</button>
            <button id="btnDisableAllAds" class="w-full py-2 px-3 text-sm rounded bg-red-600 text-white hover:bg-red-700">Desactivar Todos los Anuncios</button>
            <button id="btnResetAdsConfig" class="w-full py-2 px-3 text-sm rounded bg-gray-600 text-white hover:bg-gray-700">Restaurar Configuración</button>
          </div>
        </div>
        
        <!-- Welcome Screen Section -->
        <div id="welcomeSection" class="p-4 rounded-2xl shadow-md glass hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Configuración de Ventana Inicial</h2>
            <button id="btnRefreshWelcome" class="px-3 py-1 text-sm rounded bg-sky-600 text-white hover:bg-sky-700">Refrescar</button>
          </div>
          
          <!-- Welcome Screen Status -->
          <div class="mb-4">
            <div class="bg-blue-50 p-3 rounded-lg">
              <div class="text-sm text-blue-600 font-medium">Estado de la Ventana</div>
              <div id="welcomeStatus" class="text-lg font-bold text-blue-800">Cargando...</div>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="space-y-2">
            <button id="btnEnableWelcome" class="w-full py-2 px-3 text-sm rounded bg-green-600 text-white hover:bg-green-700">Activar Ventana Inicial</button>
            <button id="btnDisableWelcome" class="w-full py-2 px-3 text-sm rounded bg-red-600 text-white hover:bg-red-700">Desactivar Ventana Inicial</button>
            <button id="btnPreviewWelcome" class="w-full py-2 px-3 text-sm rounded bg-purple-600 text-white hover:bg-purple-700">Vista Previa</button>
          </div>
        </div>
      </aside>

      <!-- Editor + Items -->
      <section class="col-span-9">
        <!-- Packs Management Section -->
        <div id="packsManagement" class="p-6 rounded-2xl shadow-md glass">
          <form id="packForm" class="grid grid-cols-3 gap-4 items-end">
            <div class="col-span-2">
              <label class="block text-sm font-medium">Nombre</label>
              <input id="name" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="Nombre del pack" />
            </div>
            <div>
              <label class="block text-sm font-medium">Activo</label>
              <div class="mt-1"><input id="isActive" type="checkbox" class="h-5 w-5" checked /></div>
            </div>

            <div>
              <label class="block text-sm font-medium">Permitir demo gratuito</label>
              <div class="mt-1"><input id="allowDemo" type="checkbox" class="h-5 w-5" /></div>
            </div>

            <div class="col-span-3">
              <label class="block text-sm font-medium">Descripción</label>
              <input id="description" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="Descripción corta" />
            </div>

            <div>
              <label class="block text-sm font-medium">Precio</label>
              <input id="price" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="e.g. 1.99" />
            </div>

            <div>
              <label class="block text-sm font-medium">Icono</label>
              <input id="icon" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="emoji o nombre" />
            </div>

            <div>
              <label class="block text-sm font-medium">Desbloqueable por referidos</label>
              <div class="mt-1"><input id="isReferralUnlockable" type="checkbox" class="h-5 w-5" /></div>
            </div>

            <div>
              <label class="block text-sm font-medium">Referidos requeridos</label>
              <input id="requiredReferrals" type="number" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="0" min="0" />
            </div>

            <div>
              <label class="block text-sm font-medium">Desbloqueable por sugerencias</label>
              <div class="mt-1"><input id="isSuggestionUnlockable" type="checkbox" class="h-5 w-5" /></div>
            </div>

            <div>
              <label class="block text-sm font-medium">Sugerencias aprobadas requeridas</label>
              <input id="requiredApprovedSuggestions" type="number" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="0" min="0" />
            </div>

            <div class="flex gap-2 col-span-3">
              <button id="btnSavePack" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Guardar pack</button>
              <button id="btnDeletePack" type="button" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Eliminar pack</button>
              <div id="packIdDisplay" class="ml-auto text-sm text-slate-500 self-center"></div>
            </div>
          </form>

          <div class="mt-6 grid grid-cols-2 gap-4">
            <div>
              <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold">Preguntas</h3>
                <button id="btnAddQuestion" class="text-sm px-3 py-1 rounded bg-indigo-600 text-white">Añadir</button>
              </div>
              <div id="questionsList" class="max-h-[40vh] overflow-auto scrollbar-thin space-y-2"></div>
            </div>

            <div>
              <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold">Retos</h3>
                <button id="btnAddDare" class="text-sm px-3 py-1 rounded bg-rose-600 text-white">Añadir</button>
              </div>
              <div id="daresList" class="max-h-[40vh] overflow-auto scrollbar-thin space-y-2"></div>
            </div>
          </div>
        </div>
        
        <!-- Suggestions Management Section -->
        <div id="suggestionsManagement" class="p-6 rounded-2xl shadow-md glass hidden">
          <div class="mb-6">
            <h2 class="text-xl font-bold mb-2">Gestión de Sugerencias</h2>
            <p class="text-gray-600 text-sm">Administra las sugerencias enviadas por los usuarios</p>
          </div>
          
          <!-- Suggestion Details -->
          <div id="suggestionDetails" class="hidden">
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">Tipo</label>
                  <span id="suggestionType" class="text-sm text-gray-900"></span>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">Estado</label>
                  <select id="suggestionStatus" class="mt-1 block w-full rounded-md border px-3 py-2">
                    <option value="pending">Pendiente</option>
                    <option value="possible">Posible</option>
                    <option value="accepted">Aceptada</option>
                    <option value="rejected">Descartada</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">Autor</label>
                  <span id="suggestionAuthor" class="text-sm text-gray-900"></span>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">Fecha</label>
                  <span id="suggestionDate" class="text-sm text-gray-900"></span>
                </div>
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Contenido</label>
                <div id="suggestionContent" class="mt-1 p-3 bg-white rounded border text-sm"></div>
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Pack Objetivo (si aplica)</label>
                <span id="suggestionTargetPack" class="text-sm text-gray-900"></span>
              </div>
              
              <div class="flex gap-3">
                <button id="btnUpdateSuggestion" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Actualizar Estado</button>
                <button id="btnDeleteSuggestion" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Eliminar</button>
              </div>
            </div>
          </div>
          
          <!-- Statistics -->
          <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg text-center">
              <div class="text-2xl font-bold text-blue-600" id="totalSuggestions">0</div>
              <div class="text-sm text-blue-600">Total</div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg text-center">
              <div class="text-2xl font-bold text-yellow-600" id="pendingSuggestions">0</div>
              <div class="text-sm text-yellow-600">Pendientes</div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center">
              <div class="text-2xl font-bold text-green-600" id="acceptedSuggestions">0</div>
              <div class="text-sm text-green-600">Aceptadas</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg text-center">
              <div class="text-2xl font-bold text-red-600" id="rejectedSuggestions">0</div>
              <div class="text-sm text-red-600">Descartadas</div>
            </div>
          </div>
          
          <!-- Pack Configuration for Suggestions -->
          <div class="bg-purple-50 p-4 rounded-lg">
            <h3 class="font-semibold mb-3 text-purple-800">Configuración de Packs por Sugerencias</h3>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Pack</label>
                <select id="packForSuggestions" class="mt-1 block w-full rounded-md border px-3 py-2">
                  <option value="">Seleccionar pack...</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Sugerencias requeridas</label>
                <input id="requiredSuggestions" type="number" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="0" min="0" />
              </div>
              <div class="flex items-end">
                <button id="btnConfigureSuggestionPack" class="px-4 py-2 rounded bg-purple-600 text-white hover:bg-purple-700">Configurar</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Incidents Management Section -->
        <div id="incidentsManagement" class="p-6 rounded-2xl shadow-md glass hidden">
          <h2 class="text-xl font-bold mb-4">Gestión de Incidencias</h2>
          
          <!-- Incident Details -->
          <div class="bg-white p-4 rounded-lg mb-6 hidden" id="incidentDetails">
            <h3 class="font-semibold mb-3">Detalles de la Incidencia</h3>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700">ID</label>
              <span id="incidentIdDisplay" class="text-sm text-gray-900 font-mono">(ninguna)</span>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Usuario</label>
                <span id="incidentUserDisplay" class="text-sm text-gray-900">-</span>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Fecha</label>
                <span id="incidentDateDisplay" class="text-sm text-gray-900">-</span>
              </div>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700">Estado</label>
              <span id="incidentStatusDisplay" class="text-sm text-gray-900">-</span>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700">Descripción</label>
              <div id="incidentDescriptionDisplay" class="mt-1 p-3 bg-gray-50 rounded border text-sm min-h-[100px]">-</div>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Cambiar Estado</label>
              <div class="flex gap-2 flex-wrap">
                <button id="btnMarkPending" class="px-3 py-1 text-sm rounded bg-red-100 text-red-800 hover:bg-red-200">Pendiente</button>
                <button id="btnMarkInReview" class="px-3 py-1 text-sm rounded bg-yellow-100 text-yellow-800 hover:bg-yellow-200">En Revisión</button>
                <button id="btnMarkResolved" class="px-3 py-1 text-sm rounded bg-green-100 text-green-800 hover:bg-green-200">Resuelta</button>
                <button id="btnMarkRejected" class="px-3 py-1 text-sm rounded bg-gray-100 text-gray-800 hover:bg-gray-200">Rechazada</button>
              </div>
            </div>
            
            <div class="flex gap-3">
              <button id="btnDeleteIncident" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Eliminar</button>
            </div>
          </div>
          
          <!-- Statistics -->
          <div class="grid grid-cols-5 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg text-center">
              <div class="text-2xl font-bold text-blue-600" id="incidentStatsTotal">0</div>
              <div class="text-sm text-blue-600">Total</div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg text-center">
              <div class="text-2xl font-bold text-yellow-600" id="incidentStatsPending">0</div>
              <div class="text-sm text-yellow-600">Pendientes</div>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg text-center">
              <div class="text-2xl font-bold text-orange-600" id="incidentStatsInReview">0</div>
              <div class="text-sm text-orange-600">En revisión</div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center">
              <div class="text-2xl font-bold text-green-600" id="incidentStatsResolved">0</div>
              <div class="text-sm text-green-600">Resueltas</div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg text-center">
              <div class="text-2xl font-bold text-gray-600" id="incidentStatsRejected">0</div>
              <div class="text-sm text-gray-600">Rechazadas</div>
            </div>
          </div>
        </div>
        
        <!-- Statistics Management Section -->
        <div id="statsManagement" class="p-6 rounded-2xl shadow-md glass hidden">
          <h2 class="text-xl font-bold mb-4">Dashboard de Estadísticas</h2>
          
          <!-- Time Period Selector -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Período de Tiempo</label>
            <div class="flex gap-2">
              <select id="dashboardTimeFilter" class="px-4 py-2 rounded border">
                <option value="realtime">Tiempo Real (últimos 5 min)</option>
                <option value="day">Hoy</option>
                <option value="month">Este Mes</option>
                <option value="year">Este Año</option>
              </select>
              <button id="btnRefreshDashboard" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Actualizar</button>
            </div>
          </div>
          
          <!-- Main Statistics Grid -->
          <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg text-center">
              <div class="text-3xl font-bold text-blue-600" id="dashTotalUsers">-</div>
              <div class="text-sm text-blue-600">Usuarios Totales</div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center">
              <div class="text-3xl font-bold text-green-600" id="dashActiveUsers">-</div>
              <div class="text-sm text-green-600">Usuarios Activos</div>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg text-center">
              <div class="text-3xl font-bold text-purple-600" id="dashTotalGames">-</div>
              <div class="text-sm text-purple-600">Partidas Jugadas</div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg text-center">
              <div class="text-3xl font-bold text-yellow-600" id="dashTotalDemos">-</div>
              <div class="text-sm text-yellow-600">Demos Usados</div>
            </div>
          </div>
          
          <!-- Secondary Statistics -->
          <div class="grid grid-cols-2 gap-6 mb-6">
            <!-- User Types -->
            <div class="bg-white p-4 rounded-lg border">
              <h3 class="font-semibold mb-3">Tipos de Usuario</h3>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-600">Registrados:</span>
                  <span id="dashRegisteredUsers" class="font-semibold">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Anónimos:</span>
                  <span id="dashAnonymousUsers" class="font-semibold">-</span>
                </div>
              </div>
            </div>
            
            <!-- Game Statistics -->
            <div class="bg-white p-4 rounded-lg border">
              <h3 class="font-semibold mb-3">Estadísticas de Juego</h3>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-600">Partidas por día:</span>
                  <span id="dashGamesPerDay" class="font-semibold">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Demos por día:</span>
                  <span id="dashDemosPerDay" class="font-semibold">-</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Most Played Packs Table -->
          <div class="bg-white p-4 rounded-lg border">
            <h3 class="font-semibold mb-3">Packs Más Jugados</h3>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b">
                    <th class="text-left py-2">Pack</th>
                    <th class="text-right py-2">Veces Jugado</th>
                  </tr>
                </thead>
                <tbody id="dashMostPlayedTable">
                  <tr>
                    <td colspan="2" class="text-center py-4 text-gray-500">Cargando...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Recent Events -->
          <div class="bg-white p-4 rounded-lg border mt-6">
            <h3 class="font-semibold mb-3">Eventos Recientes</h3>
            <div id="recentEvents" class="space-y-2 max-h-64 overflow-auto">
              <div class="text-center py-4 text-gray-500">Cargando eventos...</div>
            </div>
          </div>
        </div>
        
        <!-- Ads Management Section -->
        <div id="adsManagement" class="p-6 rounded-2xl shadow-md glass hidden">
          <div class="mb-6">
            <h2 class="text-xl font-bold mb-2">Configuración de Anuncios</h2>
            <p class="text-gray-600 text-sm">Administra la configuración global de anuncios para la aplicación</p>
          </div>
          
          <!-- Global Ad Settings -->
          <div class="bg-white p-4 rounded-lg border mb-6">
            <h3 class="font-semibold mb-4">Configuración Global</h3>
            
            <div class="grid grid-cols-2 gap-6">
              <!-- System Status -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Estado del Sistema</label>
                <div class="flex items-center gap-3">
                  <input id="adsGlobalEnabled" type="checkbox" class="h-5 w-5" />
                  <span class="text-sm">Anuncios habilitados globalmente</span>
                </div>
              </div>
              
              <!-- Test Mode -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Modo de Prueba</label>
                <div class="flex items-center gap-3">
                  <input id="adsTestMode" type="checkbox" class="h-5 w-5" />
                  <span class="text-sm">Usar anuncios de prueba</span>
                </div>
              </div>
            </div>
            
            <!-- Global Limits -->
            <div class="grid grid-cols-3 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Límite diario por usuario</label>
                <input id="adsDailyLimit" type="number" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="10" min="0" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Límite por sesión</label>
                <input id="adsSessionLimit" type="number" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="5" min="0" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Intervalo mínimo (min)</label>
                <input id="adsMinInterval" type="number" class="mt-1 block w-full rounded-md border px-3 py-2" placeholder="2" min="0" step="0.5" />
              </div>
            </div>
          </div>
          
          <!-- Ad Types Configuration -->
          <div class="bg-white p-4 rounded-lg border mb-6">
            <h3 class="font-semibold mb-4">Configuración por Tipo de Anuncio</h3>
            
            <!-- Post Game Ads -->
            <div class="border-b pb-4 mb-4">
              <h4 class="font-medium mb-3 text-green-700">Anuncios Post-Partida</h4>
              <div class="grid grid-cols-4 gap-4">
                <div class="flex items-center gap-2">
                  <input id="postGameEnabled" type="checkbox" class="h-4 w-4" />
                  <span class="text-sm">Habilitado</span>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Probabilidad (%)</label>
                  <input id="postGameProbability" type="number" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="80" min="0" max="100" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Límite diario</label>
                  <input id="postGameDailyLimit" type="number" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="3" min="0" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Intervalo (min)</label>
                  <input id="postGameInterval" type="number" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="5" min="0" step="0.5" />
                </div>
              </div>
            </div>
            
            <!-- Post Round Ads -->
            <div class="border-b pb-4 mb-4">
              <h4 class="font-medium mb-3 text-blue-700">Anuncios Post-Ronda</h4>
              <div class="grid grid-cols-4 gap-4">
                <div class="flex items-center gap-2">
                  <input id="postRoundEnabled" type="checkbox" class="h-4 w-4" />
                  <span class="text-sm">Habilitado</span>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Probabilidad (%)</label>
                  <input id="postRoundProbability" type="number" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="30" min="0" max="100" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Límite diario</label>
                  <input id="postRoundDailyLimit" type="number" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="5" min="0" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Intervalo (min)</label>
                  <input id="postRoundInterval" type="number" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="3" min="0" step="0.5" />
                </div>
              </div>
            </div>
            
            <!-- Question Change Ads -->
            <div>
              <h4 class="font-medium mb-3 text-purple-700">Anuncios por Cambio de Pregunta</h4>
              <div class="grid grid-cols-4 gap-4">
                <div class="flex items-center gap-2">
                  <input id="questionChangeEnabled" type="checkbox" class="h-4 w-4" />
                  <span class="text-sm">Habilitado</span>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Probabilidad (%)</label>
                  <input id="questionChangeProbability" type="number" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="50" min="0" max="100" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Límite diario</label>
                  <input id="questionChangeDailyLimit" type="number" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="8" min="0" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Intervalo (min)</label>
                  <input id="questionChangeInterval" type="number" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="1" min="0" step="0.5" />
                </div>
              </div>
            </div>
          </div>
          
          <!-- Platform Settings -->
          <div class="bg-white p-4 rounded-lg border mb-6">
            <h3 class="font-semibold mb-4">Configuración por Plataforma</h3>
            
            <div class="grid grid-cols-2 gap-6">
              <!-- Android Settings -->
              <div>
                <h4 class="font-medium mb-3 text-green-600">Android</h4>
                <div class="space-y-3">
                  <div>
                    <label class="block text-xs font-medium text-gray-600">Banner Ad Unit ID</label>
                    <input id="androidBannerAdUnit" type="text" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="ca-app-pub-xxx/xxx" />
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-600">Interstitial Ad Unit ID</label>
                    <input id="androidInterstitialAdUnit" type="text" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="ca-app-pub-xxx/xxx" />
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-600">Rewarded Ad Unit ID</label>
                    <input id="androidRewardedAdUnit" type="text" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="ca-app-pub-xxx/xxx" />
                  </div>
                </div>
              </div>
              
              <!-- iOS Settings -->
              <div>
                <h4 class="font-medium mb-3 text-blue-600">iOS</h4>
                <div class="space-y-3">
                  <div>
                    <label class="block text-xs font-medium text-gray-600">Banner Ad Unit ID</label>
                    <input id="iosBannerAdUnit" type="text" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="ca-app-pub-xxx/xxx" />
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-600">Interstitial Ad Unit ID</label>
                    <input id="iosInterstitialAdUnit" type="text" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="ca-app-pub-xxx/xxx" />
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-600">Rewarded Ad Unit ID</label>
                    <input id="iosRewardedAdUnit" type="text" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="ca-app-pub-xxx/xxx" />
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex gap-3">
            <button id="btnSaveAdsConfig" class="px-6 py-2 rounded bg-green-600 text-white hover:bg-green-700">Guardar Configuración</button>
            <button id="btnLoadAdsConfig" class="px-6 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Cargar Configuración</button>
            <button id="btnResetAdsConfigFull" class="px-6 py-2 rounded bg-gray-600 text-white hover:bg-gray-700">Restaurar Valores por Defecto</button>
          </div>
          
          <!-- Current Configuration Display -->
          <div class="mt-6 bg-gray-50 p-4 rounded-lg">
            <h3 class="font-semibold mb-3">Configuración Actual (JSON)</h3>
            <pre id="currentAdsConfig" class="text-xs bg-white p-3 rounded border overflow-auto max-h-64">Cargando configuración...</pre>
          </div>
        </div>
        
        <!-- Welcome Screen Management Section -->
        <div id="welcomeManagement" class="p-6 rounded-2xl shadow-md glass hidden">
          <div class="mb-6">
            <h2 class="text-xl font-bold mb-2">Configuración de Ventana Inicial</h2>
            <p class="text-gray-600 text-sm">Administra la ventana inicial que se muestra al abrir la aplicación</p>
          </div>
          
          <!-- Global Welcome Settings -->
          <div class="bg-white p-4 rounded-lg border mb-6">
            <h3 class="font-semibold mb-4">Configuración General</h3>
            
            <div class="grid grid-cols-2 gap-6">
              <!-- System Status -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Estado de la Ventana</label>
                <div class="flex items-center gap-3">
                  <input id="welcomeEnabled" type="checkbox" class="h-5 w-5" />
                  <span class="text-sm">Ventana inicial habilitada</span>
                </div>
              </div>
              
              <!-- Show Once Per Session -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Frecuencia</label>
                <div class="flex items-center gap-3">
                  <input id="welcomeShowOnce" type="checkbox" class="h-5 w-5" />
                  <span class="text-sm">Mostrar solo una vez por sesión</span>
                </div>
              </div>
            </div>
            
            <!-- Welcome Message -->
            <div class="mt-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Mensaje Principal</label>
              <textarea id="welcomeMessage" class="w-full rounded-md border px-3 py-2" rows="3" placeholder="¡Bienvenido a la aplicación! Disfruta de la experiencia..."></textarea>
            </div>
          </div>
          
          <!-- Modules Configuration -->
          <div class="bg-white p-4 rounded-lg border mb-6">
            <h3 class="font-semibold mb-4">Módulos Disponibles</h3>
            
            <!-- Referral Progress Module -->
            <div class="border-b pb-4 mb-4">
              <h4 class="font-medium mb-3 text-blue-700">Progreso de Referidos</h4>
              <div class="grid grid-cols-3 gap-4">
                <div class="flex items-center gap-2">
                  <input id="referralModuleEnabled" type="checkbox" class="h-4 w-4" />
                  <span class="text-sm">Habilitado</span>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Objetivo de referidos</label>
                  <input id="referralGoal" type="number" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="10" min="1" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Texto del botón</label>
                  <input id="referralButtonText" type="text" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="Compartir App" />
                </div>
              </div>
            </div>
            
            <!-- Custom Messages Module -->
            <div class="border-b pb-4 mb-4">
              <h4 class="font-medium mb-3 text-green-700">Mensajes Personalizados</h4>
              <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center gap-2">
                  <input id="messagesModuleEnabled" type="checkbox" class="h-4 w-4" />
                  <span class="text-sm">Habilitado</span>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Mensaje de progreso</label>
                  <input id="progressMessage" type="text" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="Te faltan {remaining} referidos para desbloquear {pack}" />
                </div>
              </div>
            </div>
            
            <!-- Shop Button Module -->
            <div class="pb-4">
              <h4 class="font-medium mb-3 text-purple-700">Botón de Tienda</h4>
              <div class="grid grid-cols-3 gap-4">
                <div class="flex items-center gap-2">
                  <input id="shopModuleEnabled" type="checkbox" class="h-4 w-4" />
                  <span class="text-sm">Habilitado</span>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Texto del botón</label>
                  <input id="shopButtonText" type="text" class="mt-1 block w-full rounded border px-2 py-1 text-sm" placeholder="Ir a la Tienda" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600">Color del botón</label>
                  <select id="shopButtonColor" class="mt-1 block w-full rounded border px-2 py-1 text-sm">
                    <option value="blue">Azul</option>
                    <option value="green">Verde</option>
                    <option value="purple">Morado</option>
                    <option value="red">Rojo</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex gap-3">
            <button id="btnSaveWelcomeConfig" class="px-6 py-2 rounded bg-green-600 text-white hover:bg-green-700">Guardar Configuración</button>
            <button id="btnLoadWelcomeConfig" class="px-6 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Cargar Configuración</button>
            <button id="btnResetWelcomeConfig" class="px-6 py-2 rounded bg-gray-600 text-white hover:bg-gray-700">Restaurar Valores por Defecto</button>
          </div>
          
          <!-- Current Configuration Display -->
          <div class="mt-6 bg-gray-50 p-4 rounded-lg">
            <h3 class="font-semibold mb-3">Configuración Actual (JSON)</h3>
            <pre id="currentWelcomeConfig" class="text-xs bg-white p-3 rounded border overflow-auto max-h-64">Cargando configuración...</pre>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-sm text-slate-500">Recuerda configurar Firestore (security rules) y la <code>firebaseConfig</code> antes de publicar.</footer>
  </div>

  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-2xl p-6 w-full max-w-xl shadow-lg">
      <h4 id="modalTitle" class="font-semibold mb-2">Editor</h4>
      <div class="space-y-3">
        <input id="itemText" placeholder="Texto" class="w-full rounded border px-3 py-2" />
        <input id="itemCategory" placeholder="Categoría" class="w-full rounded border px-3 py-2" />
        <select id="itemType" class="w-full rounded border px-3 py-2">
          <option value="question">Pregunta</option>
          <option value="dare">Reto</option>
        </select>
        <label class="flex items-center gap-2">
          <input id="itemIsDemo" type="checkbox" class="rounded">
          <span>Es item demo (gratuito)</span>
        </label>
      </div>
      <div class="mt-4 flex justify-end gap-3">
        <button id="modalCancel" class="px-4 py-2 rounded border">Cancelar</button>
        <button id="modalSave" class="px-4 py-2 rounded bg-sky-600 text-white">Guardar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDZJqOx5eXpu3cD_FBJ8oi-hYvLCpbDXE",
      authDomain: "verdadreto-bec6a.firebaseapp.com",
      projectId: "verdadreto-bec6a",
      storageBucket: "verdadreto-bec6a.firebasestorage.app",
      messagingSenderId: "938969209658",
      appId: "1:938969209658:web:534282f57a8ff381c00e03"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const packsList = document.getElementById('packsList');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnNewPack = document.getElementById('btnNewPack');
    const btnSavePack = document.getElementById('btnSavePack');
    const btnDeletePack = document.getElementById('btnDeletePack');
    const packIdDisplay = document.getElementById('packIdDisplay');
    const nameInput = document.getElementById('name');
    const descInput = document.getElementById('description');
    const priceInput = document.getElementById('price');
    const iconInput = document.getElementById('icon');
    const isActiveInput = document.getElementById('isActive');
    const allowDemoInput = document.getElementById('allowDemo');
    const isReferralUnlockableInput = document.getElementById('isReferralUnlockable');
    const requiredReferralsInput = document.getElementById('requiredReferrals');
    const isSuggestionUnlockableInput = document.getElementById('isSuggestionUnlockable');
    const requiredApprovedSuggestionsInput = document.getElementById('requiredApprovedSuggestions');
    const questionsList = document.getElementById('questionsList');
    const daresList = document.getElementById('daresList');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalCancel = document.getElementById('modalCancel');
    const modalSave = document.getElementById('modalSave');
    const itemText = document.getElementById('itemText');
    const itemCategory = document.getElementById('itemCategory');
    const itemType = document.getElementById('itemType');
    const itemIsDemo = document.getElementById('itemIsDemo');

    // Suggestions elements
    const tabPacks = document.getElementById('tabPacks');
    const tabSuggestions = document.getElementById('tabSuggestions');
    const tabIncidents = document.getElementById('tabIncidents');
    const tabStats = document.getElementById('tabStats');
    const tabAds = document.getElementById('tabAds');
    const tabWelcome = document.getElementById('tabWelcome');
    const packsSection = document.getElementById('packsSection');
    const suggestionsSection = document.getElementById('suggestionsSection');
    const incidentsSection = document.getElementById('incidentsSection');
    const statsSection = document.getElementById('statsSection');
    const adsSection = document.getElementById('adsSection');
    const welcomeSection = document.getElementById('welcomeSection');
    const packsManagement = document.getElementById('packsManagement');
    const suggestionsManagement = document.getElementById('suggestionsManagement');
    const incidentsManagement = document.getElementById('incidentsManagement');
    const statsManagement = document.getElementById('statsManagement');
    const adsManagement = document.getElementById('adsManagement');
    const welcomeManagement = document.getElementById('welcomeManagement');
    
    // Incidents elements
    const btnRefreshIncidents = document.getElementById('btnRefreshIncidents');
    const incidentStatusFilter = document.getElementById('incidentStatusFilter');
    const incidentsList = document.getElementById('incidentsList');
    const incidentIdDisplay = document.getElementById('incidentIdDisplay');
    const incidentUserDisplay = document.getElementById('incidentUserDisplay');
    const incidentDateDisplay = document.getElementById('incidentDateDisplay');
    const incidentStatusDisplay = document.getElementById('incidentStatusDisplay');
    const incidentDescriptionDisplay = document.getElementById('incidentDescriptionDisplay');
    const btnMarkPending = document.getElementById('btnMarkPending');
    const btnMarkInReview = document.getElementById('btnMarkInReview');
    const btnMarkResolved = document.getElementById('btnMarkResolved');
    const btnDeleteIncident = document.getElementById('btnDeleteIncident');
    const incidentStatsTotal = document.getElementById('incidentStatsTotal');
    const incidentStatsPending = document.getElementById('incidentStatsPending');
    const incidentStatsInReview = document.getElementById('incidentStatsInReview');
    const incidentStatsResolved = document.getElementById('incidentStatsResolved');
    const incidentStatsRejected = document.getElementById('incidentStatsRejected');
    
    // Statistics elements
    const dashboardTimeFilter = document.getElementById('dashboardTimeFilter');
    const btnRefreshDashboard = document.getElementById('btnRefreshDashboard');
    const dashTotalUsers = document.getElementById('dashTotalUsers');
    const dashActiveUsers = document.getElementById('dashActiveUsers');
    const dashTotalGames = document.getElementById('dashTotalGames');
    const dashTotalDemos = document.getElementById('dashTotalDemos');
    const dashRegisteredUsers = document.getElementById('dashRegisteredUsers');
    const dashAnonymousUsers = document.getElementById('dashAnonymousUsers');
    const dashGamesPerDay = document.getElementById('dashGamesPerDay');
    const dashDemosPerDay = document.getElementById('dashDemosPerDay');
    const dashMostPlayedTable = document.getElementById('dashMostPlayedTable');
    const recentEvents = document.getElementById('recentEvents');
    
    // Ads elements
    const tabAds = document.getElementById('tabAds');
    const adsSection = document.getElementById('adsSection');
    const adsManagement = document.getElementById('adsManagement');
    const btnRefreshAds = document.getElementById('btnRefreshAds');
    const adsSystemStatus = document.getElementById('adsSystemStatus');
    const btnEnableAllAds = document.getElementById('btnEnableAllAds');
    const btnDisableAllAds = document.getElementById('btnDisableAllAds');
    const btnResetAdsConfig = document.getElementById('btnResetAdsConfig');
    const adsGlobalEnabled = document.getElementById('adsGlobalEnabled');
    const adsTestMode = document.getElementById('adsTestMode');
    const adsDailyLimit = document.getElementById('adsDailyLimit');
    const adsSessionLimit = document.getElementById('adsSessionLimit');
    const adsMinInterval = document.getElementById('adsMinInterval');
    const postGameEnabled = document.getElementById('postGameEnabled');
    const postGameProbability = document.getElementById('postGameProbability');
    const postGameDailyLimit = document.getElementById('postGameDailyLimit');
    const postGameInterval = document.getElementById('postGameInterval');
    const postRoundEnabled = document.getElementById('postRoundEnabled');
    const postRoundProbability = document.getElementById('postRoundProbability');
    const postRoundDailyLimit = document.getElementById('postRoundDailyLimit');
    const postRoundInterval = document.getElementById('postRoundInterval');
    const questionChangeEnabled = document.getElementById('questionChangeEnabled');
    const questionChangeProbability = document.getElementById('questionChangeProbability');
    const questionChangeDailyLimit = document.getElementById('questionChangeDailyLimit');
    const questionChangeInterval = document.getElementById('questionChangeInterval');
    const androidBannerAdUnit = document.getElementById('androidBannerAdUnit');
    const androidInterstitialAdUnit = document.getElementById('androidInterstitialAdUnit');
    const androidRewardedAdUnit = document.getElementById('androidRewardedAdUnit');
    const iosBannerAdUnit = document.getElementById('iosBannerAdUnit');
    const iosInterstitialAdUnit = document.getElementById('iosInterstitialAdUnit');
    const iosRewardedAdUnit = document.getElementById('iosRewardedAdUnit');
    const btnSaveAdsConfig = document.getElementById('btnSaveAdsConfig');
    const btnLoadAdsConfig = document.getElementById('btnLoadAdsConfig');
    const btnResetAdsConfigFull = document.getElementById('btnResetAdsConfigFull');
    const currentAdsConfigElement = document.getElementById('currentAdsConfig');
    
    // Welcome Screen elements
    const btnRefreshWelcome = document.getElementById('btnRefreshWelcome');
    const btnEnableWelcome = document.getElementById('btnEnableWelcome');
    const btnDisableWelcome = document.getElementById('btnDisableWelcome');
    const btnPreviewWelcome = document.getElementById('btnPreviewWelcome');
    const welcomeStatus = document.getElementById('welcomeStatus');
    const welcomeEnabled = document.getElementById('welcomeEnabled');
    const welcomeShowOnce = document.getElementById('welcomeShowOnce');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const referralModuleEnabled = document.getElementById('referralModuleEnabled');
    const referralGoal = document.getElementById('referralGoal');
    const referralButtonText = document.getElementById('referralButtonText');
    const messagesModuleEnabled = document.getElementById('messagesModuleEnabled');
    const progressMessage = document.getElementById('progressMessage');
    const shopModuleEnabled = document.getElementById('shopModuleEnabled');
    const shopButtonText = document.getElementById('shopButtonText');
    const shopButtonColor = document.getElementById('shopButtonColor');
    const btnSaveWelcomeConfig = document.getElementById('btnSaveWelcomeConfig');
    const btnLoadWelcomeConfig = document.getElementById('btnLoadWelcomeConfig');
    const btnResetWelcomeConfig = document.getElementById('btnResetWelcomeConfig');
    const currentWelcomeConfig = document.getElementById('currentWelcomeConfig');
    
    let selectedIncidentId = null;
    const suggestionsList = document.getElementById('suggestionsList');
    const suggestionStatusFilter = document.getElementById('suggestionStatusFilter');
    const btnRefreshSuggestions = document.getElementById('btnRefreshSuggestions');
    const suggestionDetails = document.getElementById('suggestionDetails');
    const btnUpdateSuggestion = document.getElementById('btnUpdateSuggestion');
    const btnDeleteSuggestion = document.getElementById('btnDeleteSuggestion');
    const packForSuggestions = document.getElementById('packForSuggestions');
    const requiredSuggestions = document.getElementById('requiredSuggestions');
    const btnConfigureSuggestionPack = document.getElementById('btnConfigureSuggestionPack');

    let selectedPackId = null;
    let editingItemId = null;
    let selectedSuggestionId = null;
    let currentView = 'packs';

    // ------------------- AUTENTICACIÓN -------------------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.getElementById("loginSection").classList.remove("hidden");
        document.querySelector("main").classList.add("hidden");
      } else {
        await checkUserAuthorization(user);
      }
    });

    document.getElementById("loginBtn").addEventListener("click", async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        await checkUserAuthorization(user);
      } catch (err) {
        document.getElementById("loginError").innerText = err.message;
      }
    });

    async function checkUserAuthorization(user) {
      const settingsRef = doc(db, "portalConfig", "settings");
      const snap = await getDoc(settingsRef);
      if (!snap.exists()) {
        document.body.innerHTML = "<p class='p-6 text-red-600'>⚠️ Configuración no encontrada</p>";
        return;
      }

      const allowed = snap.data().allowedEmails || [];
      if (!allowed.includes(user.email)) {
        document.body.innerHTML = "<p class='p-6 text-red-600'>🚫 Usuario no autorizado</p>";
        return;
      }

      // Usuario autorizado
      document.getElementById("loginSection").classList.add("hidden");
      document.querySelector("main").classList.remove("hidden");
      fetchPacks();
      setupTabNavigation();
    }

    // ------------------- TAB NAVIGATION -------------------
    function setupTabNavigation() {
      tabPacks.addEventListener('click', () => switchToTab('packs'));
    tabSuggestions.addEventListener('click', () => switchToTab('suggestions'));
    tabIncidents.addEventListener('click', () => switchToTab('incidents'));
    tabStats.addEventListener('click', () => switchToTab('stats'));
    tabAds.addEventListener('click', () => switchToTab('ads'));
    tabWelcome.addEventListener('click', () => switchToTab('welcome'));
    btnRefreshDashboard.addEventListener('click', loadDashboardData);
      btnRefreshSuggestions.addEventListener('click', fetchSuggestions);
        suggestionStatusFilter.addEventListener('change', fetchSuggestions);
        btnRefreshIncidents.addEventListener('click', fetchIncidents);
        btnRefreshAds.addEventListener('click', loadAdsConfig);
        btnEnableAllAds.addEventListener('click', enableAllAds);
        btnDisableAllAds.addEventListener('click', disableAllAds);
        btnResetAdsConfig.addEventListener('click', resetAdsConfig);
        btnSaveAdsConfig.addEventListener('click', saveAdsConfig);
        btnLoadAdsConfig.addEventListener('click', loadAdsConfig);
        btnResetAdsConfigFull.addEventListener('click', resetAdsConfigFull);
        btnRefreshWelcome.addEventListener('click', loadWelcomeConfig);
        btnEnableWelcome.addEventListener('click', enableWelcomeScreen);
        btnDisableWelcome.addEventListener('click', disableWelcomeScreen);
        btnPreviewWelcome.addEventListener('click', previewWelcomeScreen);
        btnSaveWelcomeConfig.addEventListener('click', saveWelcomeConfig);
        btnLoadWelcomeConfig.addEventListener('click', loadWelcomeConfig);
        btnResetWelcomeConfig.addEventListener('click', resetWelcomeConfig);
        incidentStatusFilter.addEventListener('change', fetchIncidents);
        btnMarkPending.addEventListener('click', () => updateIncidentStatus('pending'));
        btnMarkInReview.addEventListener('click', () => updateIncidentStatus('in_review'));
        btnMarkResolved.addEventListener('click', () => updateIncidentStatus('resolved'));
        btnMarkRejected.addEventListener('click', () => updateIncidentStatus('rejected'));
        btnDeleteIncident.addEventListener('click', deleteIncident);
      btnUpdateSuggestion.addEventListener('click', updateSuggestionStatus);
      btnDeleteSuggestion.addEventListener('click', deleteSuggestion);
      btnConfigureSuggestionPack.addEventListener('click', configureSuggestionPack);
    }

    function switchToTab(tab) {
      currentView = tab;
      
      // Reset all tabs to inactive state
      const inactiveClass = 'px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
      const activeClass = 'px-4 py-2 rounded-lg font-medium bg-sky-600 text-white shadow-md hover:bg-sky-700 transition-colors';
      
      tabPacks.className = inactiveClass;
      tabSuggestions.className = inactiveClass;
      tabIncidents.className = inactiveClass;
      tabStats.className = inactiveClass;
      tabAds.className = inactiveClass;
      tabWelcome.className = inactiveClass;
      
      // Hide all sections
      packsSection.classList.add('hidden');
      suggestionsSection.classList.add('hidden');
      incidentsSection.classList.add('hidden');
      statsSection.classList.add('hidden');
      adsSection.classList.add('hidden');
      welcomeSection.classList.add('hidden');
      packsManagement.classList.add('hidden');
      suggestionsManagement.classList.add('hidden');
      incidentsManagement.classList.add('hidden');
      statsManagement.classList.add('hidden');
      adsManagement.classList.add('hidden');
      welcomeManagement.classList.add('hidden');
      
      if (tab === 'packs') {
        tabPacks.className = activeClass;
        packsSection.classList.remove('hidden');
        packsManagement.classList.remove('hidden');
      } else if (tab === 'suggestions') {
        tabSuggestions.className = activeClass;
        suggestionsSection.classList.remove('hidden');
        suggestionsManagement.classList.remove('hidden');
        fetchSuggestions();
        loadPacksForSuggestions();
      } else if (tab === 'incidents') {
        tabIncidents.className = activeClass;
        incidentsSection.classList.remove('hidden');
        incidentsManagement.classList.remove('hidden');
        fetchIncidents();
        loadIncidentStats();
      } else if (tab === 'stats') {
        tabStats.className = activeClass;
        statsSection.classList.remove('hidden');
        statsManagement.classList.remove('hidden');
        loadDashboardData();
      } else if (tab === 'ads') {
        tabAds.className = activeClass;
        adsSection.classList.remove('hidden');
        adsManagement.classList.remove('hidden');
        loadAdsConfig();
      } else if (tab === 'welcome') {
        tabWelcome.className = activeClass;
        welcomeSection.classList.remove('hidden');
        welcomeManagement.classList.remove('hidden');
        loadWelcomeConfig();
      }
    }

    // ------------------- SUGGESTIONS MANAGEMENT -------------------
    async function fetchSuggestions() {
      suggestionsList.innerHTML = 'Cargando...';
      const filter = suggestionStatusFilter.value;
      
      let q = collection(db, 'suggestions');
      if (filter !== 'all') {
        q = query(q, where('status', '==', filter));
      }
      
      const snap = await getDocs(q);
      suggestionsList.innerHTML = '';
      
      const suggestions = [];
      snap.forEach(d => {
        suggestions.push({ id: d.id, ...d.data() });
      });
      
      // Sort by creation date (newest first)
      suggestions.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
      
      suggestions.forEach(suggestion => {
        const node = document.createElement('div');
        node.className = 'p-3 rounded-lg hover:bg-slate-50 flex justify-between items-start cursor-pointer border-l-4 ' + getStatusColor(suggestion.status);
        
        const typeIcon = suggestion.type === 'pack' ? '📦' : suggestion.type === 'question' ? '❓' : '🎯';
        const date = suggestion.createdAt ? new Date(suggestion.createdAt.toMillis()).toLocaleDateString() : 'N/A';
        
        node.innerHTML = `
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span>${typeIcon}</span>
              <span class="font-medium text-sm">${escapeHtml(suggestion.type.toUpperCase())}</span>
              <span class="text-xs text-gray-500">${date}</span>
            </div>
            <div class="text-sm text-gray-700 mb-1">${escapeHtml(suggestion.content.substring(0, 100))}${suggestion.content.length > 100 ? '...' : ''}</div>
            <div class="text-xs text-gray-500">Por: ${escapeHtml(suggestion.authorEmail || 'Anónimo')}</div>
          </div>
          <div class="text-xs px-2 py-1 rounded ${getStatusBadge(suggestion.status)}">
            ${getStatusText(suggestion.status)}
          </div>
        `;
        
        node.addEventListener('click', () => selectSuggestion(suggestion.id, suggestion));
        suggestionsList.appendChild(node);
      });
      
      updateSuggestionStats(suggestions);
    }

    function getStatusColor(status) {
      switch(status) {
        case 'pending': return 'border-yellow-400';
        case 'possible': return 'border-blue-400';
        case 'accepted': return 'border-green-400';
        case 'rejected': return 'border-red-400';
        default: return 'border-gray-400';
      }
    }

    function getStatusBadge(status) {
      switch(status) {
        case 'pending': return 'bg-yellow-100 text-yellow-800';
        case 'possible': return 'bg-blue-100 text-blue-800';
        case 'accepted': return 'bg-green-100 text-green-800';
        case 'rejected': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    function getStatusText(status) {
      switch(status) {
        case 'pending': return 'Pendiente';
        case 'possible': return 'Posible';
        case 'accepted': return 'Aceptada';
        case 'rejected': return 'Descartada';
        default: return status;
      }
    }

    function selectSuggestion(id, suggestion) {
      selectedSuggestionId = id;
      
      document.getElementById('suggestionType').textContent = suggestion.type.toUpperCase();
      document.getElementById('suggestionStatus').value = suggestion.status;
      document.getElementById('suggestionAuthor').textContent = suggestion.authorEmail || 'Anónimo';
      document.getElementById('suggestionDate').textContent = suggestion.createdAt ? 
        new Date(suggestion.createdAt.toMillis()).toLocaleString() : 'N/A';
      document.getElementById('suggestionContent').textContent = suggestion.content;
      document.getElementById('suggestionTargetPack').textContent = suggestion.targetPack || 'N/A';
      
      suggestionDetails.classList.remove('hidden');
    }

    async function updateSuggestionStatus() {
      if (!selectedSuggestionId) return;
      
      const newStatus = document.getElementById('suggestionStatus').value;
      
      try {
        await updateDoc(doc(db, 'suggestions', selectedSuggestionId), {
          status: newStatus,
          updatedAt: new Date()
        });
        
        // If accepted, increment user's accepted suggestions count
        if (newStatus === 'accepted') {
          const suggestionDoc = await getDoc(doc(db, 'suggestions', selectedSuggestionId));
          if (suggestionDoc.exists()) {
            const suggestion = suggestionDoc.data();
            if (suggestion.authorId) {
              const userRef = doc(db, 'users', suggestion.authorId);
              const userDoc = await getDoc(userRef);
              if (userDoc.exists()) {
                const currentCount = userDoc.data().acceptedSuggestions || 0;
                await updateDoc(userRef, {
                  acceptedSuggestions: currentCount + 1
                });
              }
            }
          }
        }
        
        alert('Estado actualizado correctamente');
        fetchSuggestions();
      } catch (error) {
        console.error('Error updating suggestion:', error);
        alert('Error al actualizar el estado');
      }
    }

    async function deleteSuggestion() {
      if (!selectedSuggestionId) return;
      
      if (!confirm('¿Estás seguro de que quieres eliminar esta sugerencia?')) return;
      
      try {
        await deleteDoc(doc(db, 'suggestions', selectedSuggestionId));
        alert('Sugerencia eliminada');
        suggestionDetails.classList.add('hidden');
        selectedSuggestionId = null;
        fetchSuggestions();
      } catch (error) {
        console.error('Error deleting suggestion:', error);
        alert('Error al eliminar la sugerencia');
      }
    }

    function updateSuggestionStats(suggestions) {
      const total = suggestions.length;
      const pending = suggestions.filter(s => s.status === 'pending').length;
      const accepted = suggestions.filter(s => s.status === 'accepted').length;
      const rejected = suggestions.filter(s => s.status === 'rejected').length;
      
      document.getElementById('totalSuggestions').textContent = total;
      document.getElementById('pendingSuggestions').textContent = pending;
      document.getElementById('acceptedSuggestions').textContent = accepted;
      document.getElementById('rejectedSuggestions').textContent = rejected;
    }

    async function loadPacksForSuggestions() {
      const snap = await getDocs(collection(db, 'packs'));
      packForSuggestions.innerHTML = '<option value="">Seleccionar pack...</option>';
      
      snap.forEach(d => {
        const pack = d.data();
        const option = document.createElement('option');
        option.value = d.id;
        option.textContent = pack.name || d.id;
        packForSuggestions.appendChild(option);
      });
    }

    async function configureSuggestionPack() {
      const packId = packForSuggestions.value;
      const requiredCount = parseInt(requiredSuggestions.value) || 0;
      
      if (!packId) {
        alert('Selecciona un pack');
        return;
      }
      
      try {
        await updateDoc(doc(db, 'packs', packId), {
          isSuggestionUnlockable: true,
          requiredSuggestions: requiredCount
        });
        
        alert(`Pack configurado: se requieren ${requiredCount} sugerencias aceptadas para desbloquearlo`);
        packForSuggestions.value = '';
        requiredSuggestions.value = '';
      } catch (error) {
        console.error('Error configuring pack:', error);
        alert('Error al configurar el pack');
      }
    }

    // ------------------- CRUD PACKS -------------------
    async function fetchPacks() {
      packsList.innerHTML = 'Cargando...';
      const snap = await getDocs(collection(db, 'packs'));
      packsList.innerHTML = '';
      snap.forEach(d => {
        const pack = d.data(), id = d.id;
        const node = document.createElement('div');
        node.className = 'p-3 rounded-lg hover:bg-slate-50 flex justify-between items-center cursor-pointer';
        node.innerHTML = `<div><div class="font-medium">${escapeHtml(pack.name||id)}</div><div class="text-xs text-slate-500">${escapeHtml(pack.description||'')}</div></div><div class="text-sm">${pack.isActive? '✅': '❌'}</div>`;
        node.addEventListener('click', ()=> selectPack(id));
        packsList.appendChild(node);
      });
    }

    async function selectPack(id) {
      selectedPackId = id;
      packIdDisplay.textContent = id;
      const d = await getDoc(doc(db, 'packs', id));
      if(!d.exists()) return;
      const p = d.data();
      nameInput.value = p.name || '';
      descInput.value = p.description || '';
      priceInput.value = p.price || '';
      iconInput.value = p.icon || '';
      isActiveInput.checked = !!p.isActive;
      allowDemoInput.checked = !!p.allowDemo;
      isReferralUnlockableInput.checked = !!p.isReferralUnlockable;
      requiredReferralsInput.value = p.requiredReferrals || 0;
      isSuggestionUnlockableInput.checked = !!p.isSuggestionUnlockable;
      requiredApprovedSuggestionsInput.value = p.requiredApprovedSuggestions || 0;
      await fetchItems(id);
    }

    async function savePack(e) {
      e.preventDefault();
      const name = nameInput.value.trim();
      if (!name) {
        alert('Escribe un nombre');
        return;
      }

      // Si ya hay un pack seleccionado, usamos su id
      const id = selectedPackId || name.toLowerCase().replace(/\s+/g, '_');

      const payload = {
        id,
        name,
        description: descInput.value,
        price: priceInput.value,
        icon: iconInput.value,
        isActive: isActiveInput.checked,
        allowDemo: allowDemoInput.checked,
        isReferralUnlockable: isReferralUnlockableInput.checked,
        requiredReferrals: parseInt(requiredReferralsInput.value) || 0,
        isSuggestionUnlockable: isSuggestionUnlockableInput.checked,
        requiredApprovedSuggestions: parseInt(requiredApprovedSuggestionsInput.value) || 0
      };

      // updateDoc si ya existe, setDoc con merge si es nuevo
      if (selectedPackId) {
        await updateDoc(doc(db, 'packs', id), payload);
      } else {
        await setDoc(doc(db, 'packs', id), payload);
        selectedPackId = id; // ahora ya está seleccionado
      }

      await fetchPacks();
      selectPack(id);
      alert('Pack guardado');
    }


    async function deletePack() {
      if(!selectedPackId) return alert('Selecciona un pack');
      if(!confirm('¿Eliminar pack y sus items?')) return;
      const itemsQ = query(collection(db, 'gameItems'), where('packId','==',selectedPackId));
      const itemsSnap = await getDocs(itemsQ);
      for(const it of itemsSnap.docs) await deleteDoc(doc(db, 'gameItems', it.id));
      await deleteDoc(doc(db, 'packs', selectedPackId));
      selectedPackId = null;
      packIdDisplay.textContent = '';
      clearForm();
      await fetchPacks();
      alert('Eliminado');
    }

    function clearForm() {
      nameInput.value='';
      descInput.value='';
      priceInput.value='';
      iconInput.value='';
      isActiveInput.checked = true;
      allowDemoInput.checked = false;
      isReferralUnlockableInput.checked = false;
      requiredReferralsInput.value = 0;
      questionsList.innerHTML='';
      daresList.innerHTML='';
    }

    // ------------------- CRUD ITEMS -------------------
    async function fetchItems(packId) {
	  questionsList.innerHTML = 'Cargando...';
	  daresList.innerHTML = 'Cargando...';

	  const qSnap = await getDocs(query(collection(db, 'gameItems'), where('packId', '==', packId)));
	  
	  // Limpiar listas
	  questionsList.innerHTML = '';
	  daresList.innerHTML = '';

	  qSnap.forEach(d => {
		const it = d.data();
		const id = d.id;

		const node = document.createElement('div');
		node.className = 'p-2 rounded-md border flex justify-between items-start gap-2';
		node.innerHTML = `<div>
							<div class="font-medium">${escapeHtml(it.text)} ${it.isDemo ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">DEMO</span>' : ''}</div>
							<div class="text-xs text-slate-500">${escapeHtml(it.category)}</div>
						  </div>
						  <div class="flex gap-2">
							<button data-id="${id}" class="editBtn text-sm px-2 py-1 rounded bg-yellow-400">Editar</button>
							<button data-id="${id}" class="delBtn text-sm px-2 py-1 rounded bg-red-500 text-white">Eliminar</button>
						  </div>`;

		if(it.type === 'question') questionsList.appendChild(node);
		else if(it.type === 'dare') daresList.appendChild(node);
	  });

	  // Attach handlers
	  document.querySelectorAll('.editBtn').forEach(b => b.addEventListener('click', ()=> openEditItem(b.dataset.id)));
	  document.querySelectorAll('.delBtn').forEach(b => b.addEventListener('click', async ()=>{
		if(confirm('Eliminar item?')){
		  await deleteDoc(doc(db, 'gameItems', b.dataset.id));
		  fetchItems(packId);
		}
	  }));
	}

    function openModal(){ modal.classList.remove('hidden'); modal.style.display='flex'; }
    function closeModal(){ modal.classList.add('hidden'); modal.style.display='none'; }
    function openNewItem(type){ editingItemId=null; itemType.value=type; itemText.value=''; itemCategory.value=''; itemIsDemo.checked=false; modalTitle.textContent = type==='question'?'Nueva Pregunta':'Nuevo Reto'; openModal(); }
    async function openEditItem(itemId){ const d=await getDoc(doc(db,'gameItems',itemId)); if(!d.exists()) return; const it=d.data(); editingItemId=itemId; itemText.value=it.text||''; itemCategory.value=it.category||''; itemType.value=it.type||'question'; itemIsDemo.checked=!!it.isDemo; modalTitle.textContent='Editar item'; openModal(); }

    modalCancel.addEventListener('click', closeModal);
    modalSave.addEventListener('click', async ()=>{
      const text=itemText.value.trim(), category=itemCategory.value.trim(), type=itemType.value, isDemo=itemIsDemo.checked;
      if(!text||!category) return alert('Completa todos los campos');
      if(!selectedPackId) return alert('Selecciona un pack primero');
      if(editingItemId){
        await updateDoc(doc(db,'gameItems',editingItemId),{text,category,type,isDemo});
      } else {
        await addDoc(collection(db,'gameItems'),{packId:selectedPackId,type,text,category,isDemo});
      }
      closeModal();
      fetchItems(selectedPackId);
    });

    btnRefresh.addEventListener('click', fetchPacks);
    btnNewPack.addEventListener('click', ()=>{ clearForm(); selectedPackId=null; packIdDisplay.textContent='(nuevo)'; });
    btnSavePack.addEventListener('click', savePack);
    btnDeletePack.addEventListener('click', deletePack);
    document.getElementById('btnAddQuestion').addEventListener('click', ()=>openNewItem('question'));
    document.getElementById('btnAddDare').addEventListener('click', ()=>openNewItem('dare'));

    // Lógica para mostrar/ocultar campo de referidos requeridos
    const referralUnlockableCheckbox = document.getElementById('isReferralUnlockable');
    const requiredReferralsLabel = document.querySelector('label[for="requiredReferrals"]');
    const requiredReferralsContainer = requiredReferralsLabel ? requiredReferralsLabel.parentElement : null;
    
    function toggleRequiredReferralsVisibility() {
      if (requiredReferralsContainer) {
        if (referralUnlockableCheckbox.checked) {
          requiredReferralsContainer.style.display = 'block';
        } else {
          requiredReferralsContainer.style.display = 'none';
          const requiredReferralsInput = document.getElementById('requiredReferrals');
          if (requiredReferralsInput) requiredReferralsInput.value = 0;
        }
      }
    }
    
    // Inicializar visibilidad al cargar la página
    toggleRequiredReferralsVisibility();
    
    // Agregar event listener para el checkbox
    referralUnlockableCheckbox.addEventListener('change', toggleRequiredReferralsVisibility);

    // ------------------- INCIDENTS MANAGEMENT -------------------
    async function fetchIncidents() {
      incidentsList.innerHTML = 'Cargando...';
      const filter = incidentStatusFilter.value;
      
      let q = collection(db, 'incidents');
      if (filter !== 'all') {
        q = query(q, where('status', '==', filter));
      }
      
      const snap = await getDocs(q);
      incidentsList.innerHTML = '';
      
      const incidents = [];
      snap.forEach(d => {
        incidents.push({ id: d.id, ...d.data() });
      });
      
      // Sort by creation date (newest first)
      incidents.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
      
      incidents.forEach(incident => {
        const node = document.createElement('div');
        node.className = 'p-3 rounded-lg hover:bg-slate-50 flex justify-between items-start cursor-pointer border-l-4 ' + getIncidentStatusColor(incident.status);
        
        const date = incident.timestamp ? new Date(incident.timestamp.toMillis()).toLocaleDateString() : 'N/A';
        
        node.innerHTML = `
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span>🚨</span>
              <span class="font-medium text-sm">INCIDENCIA</span>
              <span class="text-xs text-gray-500">${date}</span>
            </div>
            <div class="text-sm text-gray-700 mb-1">${escapeHtml(incident.description.substring(0, 100))}${incident.description.length > 100 ? '...' : ''}</div>
            <div class="text-xs text-gray-500">Por: ${escapeHtml(incident.userEmail || 'Anónimo')}</div>
          </div>
          <div class="text-xs px-2 py-1 rounded ${getIncidentStatusBadge(incident.status)}">
            ${getIncidentStatusText(incident.status)}
          </div>
        `;
        
        node.addEventListener('click', () => selectIncident(incident.id, incident));
        incidentsList.appendChild(node);
      });
      
      if (incidents.length === 0) {
        incidentsList.innerHTML = '<div class="text-center text-gray-500 py-4">No hay incidencias</div>';
      }
    }
    
    function selectIncident(id, incident) {
      selectedIncidentId = id;
      incidentIdDisplay.textContent = id;
      incidentUserDisplay.textContent = incident.userEmail || 'Anónimo';
      incidentDateDisplay.textContent = incident.timestamp ? new Date(incident.timestamp.toMillis()).toLocaleDateString() : 'N/A';
      incidentStatusDisplay.textContent = getIncidentStatusText(incident.status);
      incidentDescriptionDisplay.textContent = incident.description;
      
      // Show incident details panel
      document.getElementById('incidentDetails').classList.remove('hidden');
    }
    
    async function updateIncidentStatus(status) {
      if (!selectedIncidentId) {
        alert('Selecciona una incidencia');
        return;
      }
      
      try {
        await updateDoc(doc(db, 'incidents', selectedIncidentId), {
          status: status,
          updatedAt: new Date()
        });
        
        alert(`Incidencia marcada como ${getIncidentStatusText(status)}`);
        fetchIncidents();
        loadIncidentStats();
      } catch (error) {
        console.error('Error updating incident:', error);
        alert('Error al actualizar la incidencia');
      }
    }
    
    async function deleteIncident() {
      if (!selectedIncidentId) {
        alert('Selecciona una incidencia');
        return;
      }
      
      if (!confirm('¿Estás seguro de que quieres eliminar esta incidencia?')) {
        return;
      }
      
      try {
        await deleteDoc(doc(db, 'incidents', selectedIncidentId));
        alert('Incidencia eliminada');
        selectedIncidentId = null;
        incidentIdDisplay.textContent = '(ninguna)';
        incidentUserDisplay.textContent = '-';
        incidentDateDisplay.textContent = '-';
        incidentStatusDisplay.textContent = '-';
        incidentDescriptionDisplay.textContent = '-';
        fetchIncidents();
        loadIncidentStats();
      } catch (error) {
        console.error('Error deleting incident:', error);
        alert('Error al eliminar la incidencia');
      }
    }
    
    async function loadIncidentStats() {
      try {
        const snap = await getDocs(collection(db, 'incidents'));
        let total = 0, pending = 0, inReview = 0, resolved = 0, rejected = 0;
        
        snap.forEach(d => {
          const incident = d.data();
          total++;
          if (incident.status === 'pending') pending++;
          else if (incident.status === 'in_review') inReview++;
          else if (incident.status === 'resolved') resolved++;
          else if (incident.status === 'rejected') rejected++;
        });
        
        incidentStatsTotal.textContent = total;
        incidentStatsPending.textContent = pending;
        incidentStatsInReview.textContent = inReview;
        incidentStatsResolved.textContent = resolved;
        incidentStatsRejected.textContent = rejected;
      } catch (error) {
        console.error('Error loading incident stats:', error);
      }
    }
    
    function getIncidentStatusColor(status) {
      switch (status) {
        case 'pending': return 'border-red-400';
        case 'in_review': return 'border-yellow-400';
        case 'resolved': return 'border-green-400';
        case 'rejected': return 'border-gray-400';
        default: return 'border-gray-400';
      }
    }
    
    function getIncidentStatusBadge(status) {
      switch (status) {
        case 'pending': return 'bg-red-100 text-red-800';
        case 'in_review': return 'bg-yellow-100 text-yellow-800';
        case 'resolved': return 'bg-green-100 text-green-800';
        case 'rejected': return 'bg-gray-100 text-gray-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }
    
    function getIncidentStatusText(status) {
      switch (status) {
        case 'pending': return 'Pendiente';
        case 'in_review': return 'En Revisión';
        case 'resolved': return 'Resuelto';
        case 'rejected': return 'Rechazada';
        default: return 'Desconocido';
      }
    }
    
    // ------------------- STATISTICS MANAGEMENT -------------------
    async function loadDashboardData() {
      try {
        const timeFilter = dashboardTimeFilter.value;
        const timeRange = getTimeRange(timeFilter);
        
        // Load analytics data
        const analyticsQuery = query(
          collection(db, 'analytics'),
          where('timestamp', '>=', timeRange.start),
          where('timestamp', '<=', timeRange.end)
        );
        
        const analyticsSnap = await getDocs(analyticsQuery);
        const events = [];
        analyticsSnap.forEach(doc => {
          events.push({ id: doc.id, ...doc.data() });
        });
        
        // Calculate statistics
        const stats = calculateStatistics(events, timeFilter);
        
        // Update UI
        updateDashboardUI(stats);
        updateMostPlayedPacks(events);
        updateRecentEvents(events.slice(-10));
        
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showDashboardError();
      }
    }
    
    function getTimeRange(filter) {
      const now = new Date();
      let start;
      
      switch (filter) {
        case 'realtime':
          start = new Date(now.getTime() - 5 * 60 * 1000); // 5 minutes ago
          break;
        case 'day':
          start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          break;
        case 'month':
          start = new Date(now.getFullYear(), now.getMonth(), 1);
          break;
        case 'year':
          start = new Date(now.getFullYear(), 0, 1);
          break;
        default:
          start = new Date(now.getTime() - 24 * 60 * 60 * 1000); // 1 day ago
      }
      
      return { start, end: now };
    }
    
    function calculateStatistics(events, timeFilter) {
      const uniqueUsers = new Set();
      const registeredUsers = new Set();
      const anonymousUsers = new Set();
      let totalGames = 0;
      let totalDemos = 0;
      
      events.forEach(event => {
        if (event.userId) {
          uniqueUsers.add(event.userId);
          if (event.userType === 'registered') {
            registeredUsers.add(event.userId);
          } else {
            anonymousUsers.add(event.userId);
          }
        }
        
        if (event.eventType === 'game_start') {
          totalGames++;
        } else if (event.eventType === 'demo_used') {
          totalDemos++;
        }
      });
      
      // Calculate per-day averages for longer periods
      const timeRange = getTimeRange(timeFilter);
      const daysDiff = Math.max(1, Math.ceil((timeRange.end - timeRange.start) / (1000 * 60 * 60 * 24)));
      
      return {
        totalUsers: uniqueUsers.size,
        activeUsers: uniqueUsers.size, // For the selected period
        registeredUsers: registeredUsers.size,
        anonymousUsers: anonymousUsers.size,
        totalGames,
        totalDemos,
        gamesPerDay: Math.round(totalGames / daysDiff * 10) / 10,
        demosPerDay: Math.round(totalDemos / daysDiff * 10) / 10
      };
    }
    
    function updateDashboardUI(stats) {
      dashTotalUsers.textContent = stats.totalUsers;
      dashActiveUsers.textContent = stats.activeUsers;
      dashTotalGames.textContent = stats.totalGames;
      dashTotalDemos.textContent = stats.totalDemos;
      dashRegisteredUsers.textContent = stats.registeredUsers;
      dashAnonymousUsers.textContent = stats.anonymousUsers;
      dashGamesPerDay.textContent = stats.gamesPerDay;
      dashDemosPerDay.textContent = stats.demosPerDay;
    }
    
    function updateMostPlayedPacks(events) {
      const packCounts = {};
      
      events.forEach(event => {
        if (event.eventType === 'pack_selected' && event.packName) {
          packCounts[event.packName] = (packCounts[event.packName] || 0) + 1;
        }
      });
      
      const sortedPacks = Object.entries(packCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);
      
      dashMostPlayedTable.innerHTML = '';
      
      if (sortedPacks.length === 0) {
        dashMostPlayedTable.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">No hay datos disponibles</td></tr>';
        return;
      }
      
      sortedPacks.forEach(([packName, count]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="py-2">${packName}</td>
          <td class="text-right py-2 font-semibold">${count}</td>
        `;
        dashMostPlayedTable.appendChild(row);
      });
    }
    
    function updateRecentEvents(events) {
      recentEvents.innerHTML = '';
      
      if (events.length === 0) {
        recentEvents.innerHTML = '<div class="text-center py-4 text-gray-500">No hay eventos recientes</div>';
        return;
      }
      
      events.reverse().forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'flex justify-between items-center py-2 px-3 bg-gray-50 rounded text-sm';
        
        const eventText = getEventDescription(event);
        const timeText = formatEventTime(event.timestamp);
        
        eventDiv.innerHTML = `
          <span>${eventText}</span>
          <span class="text-gray-500 text-xs">${timeText}</span>
        `;
        
        recentEvents.appendChild(eventDiv);
      });
    }
    
    function getEventDescription(event) {
      switch (event.eventType) {
        case 'game_start':
          return `🎮 Juego iniciado (${event.gameType || 'mixto'})`;
        case 'game_end':
          return `🏁 Juego terminado (${event.totalRounds || 0} rondas)`;
        case 'pack_selected':
          return `📦 Pack seleccionado: ${event.packName || 'Desconocido'}`;
        case 'demo_used':
          return `🎯 Demo usado: ${event.packName || 'Desconocido'}`;
        default:
          return `📊 ${event.eventType || 'Evento desconocido'}`;
      }
    }
    
    function formatEventTime(timestamp) {
      if (!timestamp) return 'Hace un momento';
      
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / (1000 * 60));
      
      if (diffMins < 1) return 'Ahora';
      if (diffMins < 60) return `Hace ${diffMins}m`;
      
      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return `Hace ${diffHours}h`;
      
      const diffDays = Math.floor(diffHours / 24);
      return `Hace ${diffDays}d`;
    }
    
    function showDashboardError() {
      dashTotalUsers.textContent = 'Error';
      dashActiveUsers.textContent = 'Error';
      dashTotalGames.textContent = 'Error';
      dashTotalDemos.textContent = 'Error';
      dashRegisteredUsers.textContent = 'Error';
      dashAnonymousUsers.textContent = 'Error';
      dashGamesPerDay.textContent = 'Error';
      dashDemosPerDay.textContent = 'Error';
      dashMostPlayedTable.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-red-500">Error al cargar datos</td></tr>';
      recentEvents.innerHTML = '<div class="text-center py-4 text-red-500">Error al cargar eventos</div>';
    }

    function escapeHtml(text){ if(!text) return ''; return String(text).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // ------------------- ADS MANAGEMENT -------------------
    let currentAdsConfig = {
      globalEnabled: true,
      adTypes: {
        postGame: { enabled: true, frequency: 1 },
        postRound: { enabled: true, frequency: 3 },
        questionChange: { enabled: false, frequency: 5 }
      },
      platforms: {
        android: { enabled: true },
        ios: { enabled: true },
        web: { enabled: false }
      },
      limits: {
        maxAdsPerSession: 10,
        minTimeBetweenAds: 30
      }
    };

    async function loadAdsConfig() {
      try {
        adsStatus.textContent = 'Cargando configuración...';
        adsStatus.className = 'text-blue-600';
        
        const configRef = doc(db, 'adsConfig', 'settings');
        const snap = await getDoc(configRef);
        
        if (snap.exists()) {
          currentAdsConfig = { ...currentAdsConfig, ...snap.data() };
          updateAdsUI();
          adsStatus.textContent = 'Configuración cargada correctamente';
          adsStatus.className = 'text-green-600';
        } else {
          adsStatus.textContent = 'No hay configuración guardada, usando valores por defecto';
          adsStatus.className = 'text-yellow-600';
          updateAdsUI();
        }
      } catch (error) {
        console.error('Error loading ads config:', error);
        adsStatus.textContent = 'Error al cargar configuración';
        adsStatus.className = 'text-red-600';
      }
    }

    function updateAdsUI() {
      // Global settings
      globalAdsEnabled.checked = currentAdsConfig.globalEnabled;
      maxAdsPerSession.value = currentAdsConfig.limits?.maxAdsPerSession || 10;
      minTimeBetweenAds.value = currentAdsConfig.limits?.minTimeBetweenAds || 30;
      
      // Ad types
      postGameEnabled.checked = currentAdsConfig.adTypes?.postGame?.enabled || false;
      postGameFrequency.value = currentAdsConfig.adTypes?.postGame?.frequency || 1;
      
      postRoundEnabled.checked = currentAdsConfig.adTypes?.postRound?.enabled || false;
      postRoundFrequency.value = currentAdsConfig.adTypes?.postRound?.frequency || 3;
      
      questionChangeEnabled.checked = currentAdsConfig.adTypes?.questionChange?.enabled || false;
      questionChangeFrequency.value = currentAdsConfig.adTypes?.questionChange?.frequency || 5;
      
      // Platforms
      androidEnabled.checked = currentAdsConfig.platforms?.android?.enabled || false;
      iosEnabled.checked = currentAdsConfig.platforms?.ios?.enabled || false;
      webEnabled.checked = currentAdsConfig.platforms?.web?.enabled || false;
      
      // Update current config display
      updateCurrentConfigDisplay();
    }

    function updateCurrentConfigDisplay() {
      currentAdsConfigElement.innerHTML = `
        <div class="space-y-2">
          <div><strong>Estado Global:</strong> ${currentAdsConfig.globalEnabled ? '✅ Activado' : '❌ Desactivado'}</div>
          <div><strong>Anuncios Post-Partida:</strong> ${currentAdsConfig.adTypes?.postGame?.enabled ? '✅' : '❌'} (cada ${currentAdsConfig.adTypes?.postGame?.frequency || 1} partidas)</div>
          <div><strong>Anuncios Post-Ronda:</strong> ${currentAdsConfig.adTypes?.postRound?.enabled ? '✅' : '❌'} (cada ${currentAdsConfig.adTypes?.postRound?.frequency || 3} rondas)</div>
          <div><strong>Anuncios Cambio Pregunta:</strong> ${currentAdsConfig.adTypes?.questionChange?.enabled ? '✅' : '❌'} (cada ${currentAdsConfig.adTypes?.questionChange?.frequency || 5} cambios)</div>
          <div><strong>Plataformas:</strong> 
            ${currentAdsConfig.platforms?.android?.enabled ? 'Android ✅' : 'Android ❌'} | 
            ${currentAdsConfig.platforms?.ios?.enabled ? 'iOS ✅' : 'iOS ❌'} | 
            ${currentAdsConfig.platforms?.web?.enabled ? 'Web ✅' : 'Web ❌'}
          </div>
          <div><strong>Límites:</strong> Max ${currentAdsConfig.limits?.maxAdsPerSession || 10}/sesión, Min ${currentAdsConfig.limits?.minTimeBetweenAds || 30}s entre anuncios</div>
        </div>
      `;
    }

    async function saveAdsConfig() {
      try {
        adsStatus.textContent = 'Guardando configuración...';
        adsStatus.className = 'text-blue-600';
        
        // Update config from UI
        currentAdsConfig = {
          globalEnabled: globalAdsEnabled.checked,
          adTypes: {
            postGame: {
              enabled: postGameEnabled.checked,
              frequency: parseInt(postGameFrequency.value) || 1
            },
            postRound: {
              enabled: postRoundEnabled.checked,
              frequency: parseInt(postRoundFrequency.value) || 3
            },
            questionChange: {
              enabled: questionChangeEnabled.checked,
              frequency: parseInt(questionChangeFrequency.value) || 5
            }
          },
          platforms: {
            android: { enabled: androidEnabled.checked },
            ios: { enabled: iosEnabled.checked },
            web: { enabled: webEnabled.checked }
          },
          limits: {
            maxAdsPerSession: parseInt(maxAdsPerSession.value) || 10,
            minTimeBetweenAds: parseInt(minTimeBetweenAds.value) || 30
          },
          lastUpdated: new Date()
        };
        
        const configRef = doc(db, 'adsConfig', 'settings');
        await setDoc(configRef, currentAdsConfig);
        
        updateCurrentConfigDisplay();
        adsStatus.textContent = 'Configuración guardada correctamente';
        adsStatus.className = 'text-green-600';
      } catch (error) {
        console.error('Error saving ads config:', error);
        adsStatus.textContent = 'Error al guardar configuración';
        adsStatus.className = 'text-red-600';
      }
    }

    function enableAllAds() {
      globalAdsEnabled.checked = true;
      postGameEnabled.checked = true;
      postRoundEnabled.checked = true;
      questionChangeEnabled.checked = true;
      androidEnabled.checked = true;
      iosEnabled.checked = true;
      webEnabled.checked = true;
      adsStatus.textContent = 'Todos los anuncios habilitados (recuerda guardar)';
      adsStatus.className = 'text-green-600';
    }

    function disableAllAds() {
      globalAdsEnabled.checked = false;
      postGameEnabled.checked = false;
      postRoundEnabled.checked = false;
      questionChangeEnabled.checked = false;
      androidEnabled.checked = false;
      iosEnabled.checked = false;
      webEnabled.checked = false;
      adsStatus.textContent = 'Todos los anuncios deshabilitados (recuerda guardar)';
      adsStatus.className = 'text-red-600';
    }

    function resetAdsConfig() {
      const defaultConfig = {
        globalEnabled: true,
        adTypes: {
          postGame: { enabled: true, frequency: 1 },
          postRound: { enabled: true, frequency: 3 },
          questionChange: { enabled: false, frequency: 5 }
        },
        platforms: {
          android: { enabled: true },
          ios: { enabled: true },
          web: { enabled: false }
        },
        limits: {
          maxAdsPerSession: 10,
          minTimeBetweenAds: 30
        }
      };
      
      currentAdsConfig = defaultConfig;
      updateAdsUI();
      adsStatus.textContent = 'Configuración restablecida a valores por defecto (recuerda guardar)';
      adsStatus.className = 'text-yellow-600';
    }

    async function resetAdsConfigFull() {
      if (!confirm('¿Estás seguro de que quieres eliminar completamente la configuración de anuncios de la base de datos?')) {
        return;
      }
      
      try {
        adsStatus.textContent = 'Eliminando configuración...';
        adsStatus.className = 'text-red-600';
        
        const configRef = doc(db, 'adsConfig', 'settings');
        await deleteDoc(configRef);
        
        resetAdsConfig();
        adsStatus.textContent = 'Configuración eliminada de la base de datos';
        adsStatus.className = 'text-red-600';
      } catch (error) {
        console.error('Error deleting ads config:', error);
        adsStatus.textContent = 'Error al eliminar configuración';
        adsStatus.className = 'text-red-600';
      }
    }

    // ------------------- WELCOME SCREEN MANAGEMENT -------------------
    let currentWelcomeConfigData = {
      enabled: false,
      showOncePerSession: true,
      message: '¡Bienvenido a la aplicación! Disfruta de la experiencia...',
      modules: {
        referralProgress: {
          enabled: false,
          goal: 10,
          buttonText: 'Compartir App'
        },
        customMessages: {
          enabled: false,
          progressMessage: 'Te faltan {remaining} referidos para desbloquear {pack}'
        },
        shopButton: {
          enabled: false,
          buttonText: 'Ir a la Tienda',
          color: 'blue'
        }
      }
    };

    async function loadWelcomeConfig() {
      try {
        welcomeStatus.textContent = 'Cargando configuración...';
        welcomeStatus.className = 'text-blue-800';
        
        const configRef = doc(db, 'welcomeConfig', 'settings');
        const configSnap = await getDoc(configRef);
        
        if (configSnap.exists()) {
          currentWelcomeConfigData = configSnap.data();
        }
        
        updateWelcomeUI();
        welcomeStatus.textContent = currentWelcomeConfigData.enabled ? 'Ventana inicial habilitada' : 'Ventana inicial deshabilitada';
        welcomeStatus.className = currentWelcomeConfigData.enabled ? 'text-green-800' : 'text-red-800';
      } catch (error) {
        console.error('Error loading welcome config:', error);
        welcomeStatus.textContent = 'Error al cargar configuración';
        welcomeStatus.className = 'text-red-800';
      }
    }

    function updateWelcomeUI() {
      welcomeEnabled.checked = currentWelcomeConfigData.enabled;
      welcomeShowOnce.checked = currentWelcomeConfigData.showOncePerSession;
      welcomeMessage.value = currentWelcomeConfigData.message;
      
      referralModuleEnabled.checked = currentWelcomeConfigData.modules.referralProgress.enabled;
      referralGoal.value = currentWelcomeConfigData.modules.referralProgress.goal;
      referralButtonText.value = currentWelcomeConfigData.modules.referralProgress.buttonText;
      
      messagesModuleEnabled.checked = currentWelcomeConfigData.modules.customMessages.enabled;
      progressMessage.value = currentWelcomeConfigData.modules.customMessages.progressMessage;
      
      shopModuleEnabled.checked = currentWelcomeConfigData.modules.shopButton.enabled;
      shopButtonText.value = currentWelcomeConfigData.modules.shopButton.buttonText;
      shopButtonColor.value = currentWelcomeConfigData.modules.shopButton.color;
      
      currentWelcomeConfig.textContent = JSON.stringify(currentWelcomeConfigData, null, 2);
    }

    async function saveWelcomeConfig() {
      try {
        welcomeStatus.textContent = 'Guardando configuración...';
        welcomeStatus.className = 'text-blue-800';
        
        const configData = {
          enabled: welcomeEnabled.checked,
          showOncePerSession: welcomeShowOnce.checked,
          message: welcomeMessage.value,
          modules: {
            referralProgress: {
              enabled: referralModuleEnabled.checked,
              goal: parseInt(referralGoal.value) || 10,
              buttonText: referralButtonText.value || 'Compartir App'
            },
            customMessages: {
              enabled: messagesModuleEnabled.checked,
              progressMessage: progressMessage.value || 'Te faltan {remaining} referidos para desbloquear {pack}'
            },
            shopButton: {
              enabled: shopModuleEnabled.checked,
              buttonText: shopButtonText.value || 'Ir a la Tienda',
              color: shopButtonColor.value || 'blue'
            }
          },
          updatedAt: new Date().toISOString()
        };
        
        const configRef = doc(db, 'welcomeConfig', 'settings');
        await setDoc(configRef, configData);
        
        currentWelcomeConfigData = configData;
        updateWelcomeUI();
        
        welcomeStatus.textContent = 'Configuración guardada exitosamente';
        welcomeStatus.className = 'text-green-800';
      } catch (error) {
        console.error('Error saving welcome config:', error);
        welcomeStatus.textContent = 'Error al guardar configuración';
        welcomeStatus.className = 'text-red-800';
      }
    }

    function enableWelcomeScreen() {
      welcomeEnabled.checked = true;
      welcomeStatus.textContent = 'Ventana inicial habilitada (recuerda guardar)';
      welcomeStatus.className = 'text-green-800';
    }

    function disableWelcomeScreen() {
      welcomeEnabled.checked = false;
      welcomeStatus.textContent = 'Ventana inicial deshabilitada (recuerda guardar)';
      welcomeStatus.className = 'text-red-800';
    }

    function previewWelcomeScreen() {
      alert('Vista previa: Esta funcionalidad mostrará cómo se ve la ventana inicial con la configuración actual.');
    }

    function resetWelcomeConfig() {
      const defaultConfig = {
        enabled: false,
        showOncePerSession: true,
        message: '¡Bienvenido a la aplicación! Disfruta de la experiencia...',
        modules: {
          referralProgress: {
            enabled: false,
            goal: 10,
            buttonText: 'Compartir App'
          },
          customMessages: {
            enabled: false,
            progressMessage: 'Te faltan {remaining} referidos para desbloquear {pack}'
          },
          shopButton: {
            enabled: false,
            buttonText: 'Ir a la Tienda',
            color: 'blue'
          }
        }
      };
      
      currentWelcomeConfigData = defaultConfig;
      updateWelcomeUI();
      welcomeStatus.textContent = 'Configuración restablecida a valores por defecto (recuerda guardar)';
      welcomeStatus.className = 'text-yellow-600';
    }
  </script>

</body>
</html>
